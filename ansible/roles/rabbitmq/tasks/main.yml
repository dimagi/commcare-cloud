---
# Add and configure rabbitmq
- name: Add erlang apt repo
  apt_repository: repo='deb http://packages.erlang-solutions.com/ubuntu {{ ansible_lsb.codename}} contrib' state=present

- name: Add erlang apt key
  apt_key: url=http://packages.erlang-solutions.com/ubuntu/erlang_solutions.asc state=present

- name: Add rabbitmq official apt repository
  sudo: true
  apt_repository: repo='deb http://www.rabbitmq.com/debian/ testing main' state=present

- name: Install rabbitmq
  sudo: true
  apt: pkg=rabbitmq-server state=installed force=yes
  notify:
  - restart rabbitmq

- name: Install rabbitmq plugins
  sudo: true
  rabbitmq_plugin: >
    names=rabbitmq_management
    state=enabled

- name: Ensure vhost commcarehq is present
  sudo: true
  rabbitmq_vhost: name=commcarehq state=present
  notify:
  - restart rabbitmq

- name: Add users
  sudo: true
  rabbitmq_user: >
    user={{ AMQP_USER }}
    password={{ AMQP_PASSWORD }}
    tags='administrator'
    vhost=commcarehq
    configure_priv=.*
    write_priv=.*
    read_priv=.*
    state=present
  notify:
  - restart rabbitmq

- name: Remove default guest user
  sudo: true
  rabbitmq_user: user=guest state=absent
  notify:
  - restart rabbitmq
