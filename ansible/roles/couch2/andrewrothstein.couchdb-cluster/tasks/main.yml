---
- name: create couchdb group
  become: yes
  become_user: root
  group: name={{couchdb_group}} state=present
  
- name: create couchdb user
  become: yes
  become_user: root
  user: >-
    name={{couchdb_user}}
    group={{couchdb_group}}
    home={{couchdb_dir}}
    state=present

- name: create directories
  become: yes
  become_user: root
  with_items:
    - { d: '{{couchdb_etc_pki_dir}}', m: '0700' }
    - { d: '{{couchdb_dir}}/etc/local.d', m: '0700' }
  file: >-
    path={{item.d}}
    state=directory
    owner={{couchdb_user}}
    group={{couchdb_group}}
    mode={{item.m}}

- name: install keys/certs
  when: couchdb_secure
  become: yes
  become_user: root
  with_items:
    - { f: '{{couchdb_pki_key_src}}', d: '{{couchdb_pki_key_dest}}', m: '0400' }
    - { f: '{{couchdb_pki_cert_src}}', d: '{{couchdb_pki_cert_dest}}', m: '0600'}
    - { f: '{{couchdb_pki_ca_cert_src}}', d: '{{couchdb_pki_ca_cert_dest}}', m: '0600' }
  copy: >-
    src={{item.f}}
    dest={{item.d}}
    owner={{couchdb_user}}
    group={{couchdb_group}}
    mode={{item.m}}
    
- name: configurate....
  become: yes
  become_user: root
  with_items:
    - httpd_proxies.ini
    - chttpd.ini
    - admins.ini
    - ssl.ini
    - daemons.ini
  template: >-
    src={{item}}.j2
    dest=/usr/local/couchdb/etc/local.d/{{item}}
    owner={{couchdb_user}}
    group={{couchdb_group}}
    mode=0644
  
- name: configure system init...
  include: '{{couchdb_init}}.yml'