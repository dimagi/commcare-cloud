title: Rolling Upgrade of CouchDB Nodes
key: couchdb-upgrade
date: 2026-02-14
optional_per_env: no

# (optional) Min version of HQ that MUST be deployed before this change can be rolled out (commit hash)
min_commcare_version:
# (optional) Max version of HQ that can be deployed before this change MUST be rolled out (commit hash)
max_commcare_version:

context: |
  This changelog outlines the steps for a rolling upgrade of CouchDB nodes.

  The upgrade must be performed in two stages:
  1. Upgrade from 3.3.x to 3.4.3
  2. Upgrade from 3.4.3 to 3.5.0

  The rolling upgrade process remains the same for both stages.
  The only difference is updating the `couchdb_version` variable in
  environments/<env>/public.yml.

details: |
  CouchDB must be upgraded twice: first to version 3.4.3 and then to 3.5.0.
  The process remains identical for both steps.

  We will start by upgrading CouchDB to 3.4.3 first.
  After all nodes are successfully upgraded to 3.4.3, the same process
  must be repeated to upgrade to 3.5.0.

update_steps: |
  Perform these steps for *each CouchDB node* in your cluster, one at a time.

  ----------------------------------------------------------------------

  ### 0. Update Version in public.yml (Step 1 - Upgrade to 3.4.3)

  1. Update the CouchDB version in:
     environments/<env>/public.yml

     Set:
     couchdb_version: "3.4.3"

  2. Commit and push the change:
     sh
     git commit -am "Update CouchDB version to 3.4.3"
     git push

The version number would be used later to figure out the version that we want to deploy.

  ----------------------------------------------------------------------

  ### 1. Pre-Upgrade Variables & Traffic Management

  1. Set your node variables on the control machine:
     sh
     node_to_upgrade="<IP_OF_NODE>"
     node_name_to_upgrade="<NODE_NAME_IN_INVENTORY>"
     couch_coordinator="<IP_OF_ANY_OTHER_NODE>"

     Note:
     - If this is a single-node cluster, the `couch_coordinator` would be same as  `node_to_upgrade`.

  2. Fetch CouchDB credentials securely from secrets:
     sh
     username=$(cchq <env> secrets view COUCH_USERNAME)
     password=$(cchq <env> secrets view COUCH_PASSWORD)

  3. If you have put couch db behind a load balancer, you can remove the node from node from load balancer. It would stop any incoming traffic to that node.

  4. Stop the Pillowtop services on the control machine:
     sh
     cchq <env> service pillowtop stop --only=AppDbChangeFeedPillow,DefaultChangeFeedPillow,DomainDbKafkaPillow,UserGroupsDbKafkaPillow

  ----------------------------------------------------------------------

  ### 2. Maintenance Mode & Service Stop

  1. Put the node into maintenance mode via the coordinator:
     sh
     curl -X PUT -H "Content-type: application/json" \
     http://${username}:${password}@${couch_coordinator}:15984/_node/couchdb@${node_to_upgrade}/_config/couchdb/maintenance_mode -d '"true"'

Note - If you have configured a different port for couch db, please replace 15984. 

  2. Verify the status:
     sh
     curl http://${username}:${password}@${node_to_upgrade}:15984/_up

  3. Stop CouchDB and Monit:
     sh
     cchq <env> run-shell-command ${node_name_to_upgrade} 'systemctl stop monit && systemctl stop couchdb' -b

  4. Take a manual snapshot of the attached data volume before proceeding.
     This is a mandatory step to ensure rollback is possible if needed.
     Ensure you take a backup of the volume mounted at /opt/data (device: /dev/nvme1n1) before continuing.

  ----------------------------------------------------------------------

  ### 3. Deploy the Upgrade

  1. Run the deployment playbook, limited to the specific node:
     sh
     cchq <env> ap deploy_couchdb2.yml --limit=${node_name_to_upgrade}

  2. Verify the new version:
     sh
     curl -s http://${node_to_upgrade}:15984/ | jq .version

  3. Check cluster membership:
     sh
     curl http://${username}:${password}@${node_to_upgrade}:15984/_membership

  ----------------------------------------------------------------------

  ### 4. Restore Traffic & Pillows

  1. If using a Load Balancer, register the node back into the target group.

  2. Take the node out of maintenance mode:
     sh
     curl -X PUT -H "Content-type: application/json" \
     http://${username}:${password}@${couch_coordinator}:15984/_node/couchdb@${node_to_upgrade}/_config/couchdb/maintenance_mode -d '"false"'

  3. Verify health:
     sh
     curl http://${username}:${password}@${node_to_upgrade}:15984/_up

  4. Restart the Pillowtop services:
     sh
     cchq <env> service pillowtop start --only=AppDbChangeFeedPillow,DefaultChangeFeedPillow,DomainDbKafkaPillow,UserGroupsDbKafkaPillow

  5. After confirming the node is healthy and has rejoined the cluster,
     repeat Steps 1–4 for the next CouchDB node.
     Continue until all nodes are upgraded to 3.4.3.

  ----------------------------------------------------------------------

  ### 5. Second Upgrade Stage (Upgrade to 3.5.0)

  1. After all nodes are successfully upgraded to 3.4.3,
     update environments/<env>/public.yml again:

     Set:
     couchdb_version: "3.5.0"

  2. Commit and push the change.

  3. Repeat the entire rolling upgrade process (Steps 1–4) for each node,
     one at a time, to complete the upgrade to 3.5.0.