# Note: Make sure to add queues with associated tasks to the solo_queues list in
# validate_app_processes_config(), in app_processes.py, so they don't share a process with another queue.

- name: Add celery_bash_runner files
  template:
    src: "{{ supervisor_service_files.celery_bash_runner.template }}"
    dest: "{{ supervisor_service_files.celery_bash_runner.file_path }}"
    owner: "{{ cchq_user }}"
    group: "{{ cchq_user }}"
    mode: 0644
  when: supervisor_service_files.celery_bash_runner.should_exist

- name: define special celery services
  template:
    src: "{{ item.template }}"
    dest: "{{ item.file_path }}"
    owner: "{{ cchq_user }}"
    group: "{{ cchq_user }}"
    mode: 0600
  when: item.should_exist
  with_items:
    - "{{ supervisor_service_files.celery_flower }}"
    - "{{ supervisor_service_files.celery_beat }}"

- name: define celery workers
  template:
    src: "{{ supervisor_service_files.celery_workers.template }}"
    dest: "{{ supervisor_service_files.celery_workers.file_path }}"
    owner: "{{ cchq_user }}"
    group: "{{ cchq_user }}"
    mode: 0644
  when: supervisor_service_files.celery_workers.should_exist
  with_items:
    - env_vars:
        http_proxy: "{% if http_proxy_address is defined %}http://{{ http_proxy_address }}:{{ http_proxy_port }}{% endif %}"
        https_proxy: "{% if http_proxy_address is defined %}https://{{ http_proxy_address }}:{{ http_proxy_port }}{% endif %}"
        no_proxy: "{% if http_proxy_address is defined %}{{ groups['all'] | join(',') }},{{ app_processes_config.additional_no_proxy_hosts }}{% endif %}"
        PROMETHEUS_PUSHGATEWAY_HOST: "{% if prometheus_celery_pushgateway is defined %}{{ prometheus_celery_pushgateway }}{% endif %}"
        TMPDIR: '{{ encrypted_tmp }}'
        DD_ENV: "{{ env_monitoring_id }}"
        DD_SERVICE: "celery"
        # Set app-processes.yml:celery_processes.<host>.<proc>.env_vars.DD_TRACE_ENABLED=True
        # to enable APM on celery processes.
        # NOTE: celery_command_prefix must also be set to enable APM on celery processes
        # because automatic command prefix in celery_bash_runner.sh.j2 is too complicated.
        DD_TRACE_ENABLED: False
        DD_INSTRUMENTATION_TELEMETRY_ENABLED: False
