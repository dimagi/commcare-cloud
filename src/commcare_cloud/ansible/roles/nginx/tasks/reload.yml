---
- name: check nginx version
  become: yes
  block:
    - command: 'nginx -v'
      register: nginx_version
    - debug:
        var: nginx_version.stdout_lines

- name: check nginx configuration
  become: yes
  shell: "nginx -t"
  register: result
  check_mode: no
  failed_when: "result.rc != 0"

- name: start the nginx service (if it's not started)
  become: yes
  service: name=nginx state=started enabled=yes

- name: reload the nginx service
  become: yes
  service: name=nginx state=reloaded enabled=yes

- name: Assert nginx is running
  become: yes
  shell: 'service nginx status'
  args:
    warn: no
  register: nginx_status
  changed_when: false
  # new versions have `* nginx is running`, old have something containing `start/running`
  failed_when: nginx_status.rc != 0 or nginx_status.stdout.find('running') == -1
