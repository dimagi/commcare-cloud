---

- name: 'Link Certificate /etc/pki/tls/certs/{{ deploy_env }}_nginx_combined.crt to /etc/letsencrypt/live/{{SITE_HOST}}/fullchain.pem'
  file:
    src: '/etc/letsencrypt/live/{{SITE_HOST}}/fullchain.pem'
    path: '/etc/pki/tls/certs/{{ deploy_env }}_nginx_combined.crt'
    state: link
    remote_src: yes

- name: 'Link Privatekey /etc/pki/tls/private/{{ deploy_env }}_nginx_commcarehq.org.key to   /etc/letsencrypt/live/{{SITE_HOST}}/privkey.pem '
  file:
    src: '/etc/letsencrypt/live/{{SITE_HOST}}/privkey.pem'
    path: '/etc/pki/tls/private/{{ deploy_env }}_nginx_commcarehq.org.key'
    state: link
    remote_src: yes

- name: Reload Nginx
  service:
    name: nginx
    state: reloaded

- name: Final instructions
  pause:
    prompt: |

      Hello person who ran letsencrypt_cert.yml.

      Now you just have to finalize things by
        - making sure `fake_ssl_cert` is set to `no` (or is absent) in `proxy.yml`
        - running `commcare-cloud <env> ansible-playbook deploy_proxy.yml`
        - optionally, copying the important files from `proxy` `/etc/pki/tls/`
          to an encrypted file in the environment settings.

- name: Add certbot cron
  cron:
    name: "Certbot Renew"
    job: "test -x /usr/bin/certbot && perl -e 'sleep int(rand(3600))' && certbot -q renew"
    minute: "0"
    hour: "0/12"
    user: root
    cron_file: certbot
    state: absen  t