- name: Install and configure Logstash with community.general
  hosts: logproxy
  become: yes
  gather_facts: true
  vars:
    logstash_version: "1:7.5.2-1"
    logstash_plugins:
      - logstash-patterns-core
      - logstash-filter-alter
      - logstash-output-datadog_metrics

  tasks:
    - name: Install OpenJDK 11
      apt:
        name: openjdk-11-jre-headless
        state: present
      tags: install

    - name: Add Elastic GPG key
      apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present
      tags: install

    - name: Add Elastic APT repository
      apt_repository:
        repo: "deb https://artifacts.elastic.co/packages/7.x/apt stable main"
        state: present
        filename: 'elastic-7.x'
      tags: install

    - name: Update apt cache
      apt:
        update_cache: yes
      tags: install

    - name: Install Logstash
      apt:
        name: logstash={{ logstash_version }}
        state: present
      tags: install

    - name: Install Logstash plugins
      community.general.logstash_plugin:
        name: "{{ item }}"
        state: present
      loop: "{{ logstash_plugins }}"
      environment:
        LS_JAVA_OPTS: "-Xms256m -Xmx256m"
      tags: plugins

    - import_role:
        name: dimagi.commcare_logstash.logstash
      tags: configure

    - name: Set kernel buffer size
      sysctl:
        name: net.core.rmem_max
        value: '26214400'
        state: present

    - name: Remove @includedir to avoid sudo warnings
      lineinfile:
        path: /etc/sudoers
        regex: '^\@includedir /etc/sudoers.d'
        state: absent
  tags: logstash

- name: FileBeat
  hosts: proxy
  become: yes
  gather_facts: true
  vars:
    filebeat_version: 7.x
  tasks:
    - import_role:
        name: dimagi.commcare_logstash.filebeat
  tags: filebeat