# Creating a new environment

In this example there's a root account for your AWS organization,
and the new environment will live in it's own linked account.

1. From the root account go to organizations and create a new account.
    - use an email like <mainaccount>+<env>@<org> 
2. Enter in new account email as if to log in and then go through the Forgot Password
    workflow to set password (to something randomized and strong). Save this password.
3. Log in using the new credentials.
4. Go to my credentials and enable the root account's access key.
    Copy these to your ~/.aws/credentials as
    ```
    [<org>-<env>]
    aws_access_key_id = "..."
    aws_secret_access_key = "..."
    ```
5. Add `aws_profile: <org>-<env>` to `terraform.yml` of your env.
6. Run `cchq <env> terraform init`
7. Run `cchq <env> terraform plan -target module.commcarehq.module.Users`
    and if the user list looks good...
8. Run `cchq <env> terraform apply -target module.commcarehq.module.Users`
    and respond `yes` when prompted.
9. In AWS console, go to IAM users and click on your own username.
10. Create access key and copy them to ~/.aws/credentials,
    replacing the root credentials you had there.
11. In AWS console under My Security Credentials,
    delete the access key you originally made for the root user.
12. Log out of AWS and then log back in as your IAM user. (To give the account a memorable
    account alias, make sure to set `account_alias` in `terraform.yml`.)


## Give access to team members

Terraform will create an IAM user account for each user specified in `meta.yml`.
The accounts are created without access keys or the ability to log in,
so they are essentially "inactive" accounts.

To "activate" an account:
1. Go to IAM users and select the user.
2. Click on the Security Credentials tab. Next to "Console password" it should say "Disabled";
    click on the "Manage password" link next to that.
3. Next to "Console access" click "Enable"
4. Check the box next to "Require password reset"
5. If the person is next to you, let them type in a password from your keyboard;
    otherwise take note of the autogenerated password and send it to them securely.
6. Send them a link to https://<account_alias>.signin.aws.amazon.com/console
    and have them log in and reset their password.
7. Have them to go to My Security Credentials to create an access key
    and write it in their ~/.aws/credentials under [<aws_profile>].


## VPN Setup

The first time you run `cchq <env> terraform apply`,
it will fail with a link to a terms of service you need to accept.
To do so:
1. First, make sure you are logged into https://console.aws.amazon.com/console/home
    _under the correct account_.
    (Each environment is it's own linked account,
    so be careful you're not logged into the
    e.g. staging account if you're doing this for production) 
2. Then click on the link in the output
3. Accept the terms and click "Continue to Subscribe".

Once the VM is created, you still need to create a VPN user before you can use the VPN.
To do this, go into the console, find the vpn ec2 instance, go to its security group,
and click Inbound Traffic > Edit > Add Rule. Select Type "SSH" and Source "My IP",
and click Save. Now you will be able to SSH into the VM.

```
ssh openvpnas@<openvpn-public-ip>
sudo ovpn-init --ec2
...
Please enter 'yes' to indicate your agreement [no]: yes
... 
```
Make sure to type `yes` for the first prompt, and then just hit enter until it's done. 
Then set a password with
```
sudo passwd openvpn
```
This is the password you'll use to enter the admin web UI.

Go to `https://<vpn-ip>/admin` in your browser and log in with `openvpn`/`<password from above>`.
Under User Permissions, you can add other users.
(Passwords are set by clicking the edit button under More Settings.)
Create a user/password for yourself.

Download the openvpn client and connect to the public IP with your username and password.

Finally once you've proven you can get on the VPN and log into VMs with their private IPs,
run `cchq <env> terraform apply` again to undo the temporary change you made via the console
that allowed you to SSH into the openvpn machine from the public internet. 

To give others SSH access to the VPN machine
(right now your access is because terraform created the VM with your public key) add
```
+[openvpn]
+<vpn-private-ip>
```
to your env's inventory file and run
```
cchq <env> ansible-playbook deploy_stack.yml --tags=bootstrap-users --limit openvpn -u openvpnas --skip-check
``` 
You can then undo the above change to the inventory file.
